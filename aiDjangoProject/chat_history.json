[
  {
    "role": "system",
    "content": "你将扮演一名具有丰富经验的嵌入式系统设计工程师，结合给出的需求文档，通过代码实现一个嵌入式系统。下面两个---之间是一份需求文档，请根据这些信息先生成构建系统需要的步骤与完整的C语言代码，每个功能部分逐步实现。以下为生成代码时的注意项：\n1.禁止使用data作为参数。\n2.代码编译器为KeiluVision5。\n3.假设不存在任何已知驱动文件。\n4设计的代码需要实现全部功能。\n5.只输出完整的C语言代码不要其他内容\n要求格式为：```code你的代码```，其中代码为完整的C语言代码。"
  },
  {
    "role": "user",
    "content": "需求文档：\n---\n需求文档：基于51单片机的土壤湿度自动浇花系统\n1. 项目概述\n本项目旨在设计一个基于51单片机的土壤湿度自动浇花系统。该系统能够实时监测土壤湿度，并根据预设的湿度阈值自动控制水泵的开关，从而实现自动浇花的功能。系统还具备手动控制水泵的功能，用户可以通过按键手动开启或关闭水泵。此外，系统还提供了湿度上下限的设置功能，用户可以根据植物的需求调整湿度的报警阈值。\n\n2. 系统功能需求\n\n2.1土壤湿度检测：\n系统通过ADC0832模数转换芯片实时检测土壤湿度。\n湿度值通过数码管显示，显示范围为0-99。\n\n2.2自动浇水控制：\n系统根据检测到的土壤湿度值自动控制水泵的开关。\n当土壤湿度低于设定的下限值时，系统自动开启水泵进行浇水。\n当土壤湿度达到或超过设定的上限值时，系统自动关闭水泵。\n\n2.3手动浇水控制：\n用户可以通过按键手动开启或关闭水泵。\n手动控制优先级高于自动控制。\n\n2.4湿度上下限设置：\n用户可以通过按键设置湿度的上下限值。\n湿度上限和下限值通过数码管显示，用户可以直观地查看和调整。\n\n2.5数码管显示：\n系统通过4位数码管显示当前湿度值或设置的湿度上下限值。\n显示内容包括湿度的个位和十位，以及上下限的标志（H表示上限，L表示下限）。\n\n2.6按键功能：\n设置键：用于进入湿度上下限设置模式，切换设置项。\n增加键：用于增加当前设置的湿度值+1。\n减少键：用于减少当前设置的湿度值-1。\n手动控制键：用于手动开启或关闭水泵。\n\n3. 硬件需求\n\n3.1单片机：\n采用51系列单片机（如STC89C52）作为主控芯片。\n\n3.2单片机端口分配如下：\n\n3.2.1  P0口：用于控制数码管的段选信号。\n\n3.2.2 P1口：\nP1.0：连接ADC0832的CS引脚（片选信号）。\nP1.2：连接ADC0832的SCL引脚（时钟信号）。\nP1.3：连接ADC0832的DO引脚（数据输出）。\nP1.4-P1.7：连接独立按键（设置键、增加键、减少键、手动控制键）。\n\n3.2.3 P2口：\nP2.0：连接数码管的位选信号1（smg_we1）。\nP2.2：连接数码管的位选信号2（smg_we2）。\nP2.4：连接数码管的位选信号3（smg_we3）。\nP2.6：连接数码管的位选信号4（smg_we4）。\n\n3.2.4 P3口：\nP3.5：连接水泵控制继电器（dianji），用于控制水泵的开关。\n\n3.3 湿度传感器：\n使用ADC0832模数转换芯片连接土壤湿度传感器，用于检测土壤湿度。\nADC0832引脚连接：\nCS：连接P1.0。\nSCL：连接P1.2。\nDO：连接P1.3。\n\n3.4数码管显示：\n采用4位数码管显示当前湿度值或设置的湿度上下限值。\n\n3.5数码管连接：\n数据信号：连接P0口。\n\n3.6位选信号：\nsmg_we1：连接P2.0。\nsmg_we2：连接P2.2。\nsmg_we3：连接P2.4。\nsmg_we4：连接P2.6。\n\n3.7按键：\n使用4个独立按键，分别用于设置、增加、减少和手动控制水泵。\n\n3.8按键连接：\n设置键：连接P1.4。\n增加键：连接P1.5。\n减少键：连接P1.6。\n手动控制键：连接P1.7。\n\n3.9水泵控制：\n通过单片机的P3.5口控制继电器的开关，进而控制水泵的开启和关闭。\n\n3.10继电器连接：\n控制端：连接P3.5。\n输出端：连接水泵电源。\n\n3.11电源：\n系统需要5V直流电源供电，用于单片机、传感器、数码管和继电器的工作。\n\n4. 软件需求\n\n4.1主程序流程：\n系统上电后，初始化IO口和变量。\n进入主循环，实时检测按键状态和土壤湿度。\n根据按键状态和湿度值，执行相应的控制逻辑。\n\n4.2湿度检测：\n通过ADC0832读取土壤湿度传感器的模拟信号，并将其转换为数字信号。\n将读取的湿度值进行线性化处理，转换为0-99的范围。\n\n4.3自动浇水控制逻辑：\n当检测到的湿度值低于设定的下限值时，开启水泵。\n当检测到的湿度值达到或超过设定的上限值时，关闭水泵。\n\n4.4手动浇水控制逻辑：\n用户按下手动控制键时，直接控制水泵的开启或关闭，忽略自动控制逻辑。\n\n4.5湿度上下限设置逻辑：\n用户按下设置键后，进入湿度上下限设置模式。\n通过增加键和减少键调整当前设置的湿度值。\n设置完成后，按下设置键退出设置模式。\n\n4.6数码管显示逻辑：\n在正常模式下，数码管显示当前湿度值。\n在设置模式下，数码管显示当前设置的湿度值，并显示H或L标志。\n\n5. 系统参数\n湿度范围：湿度显示范围为0-99，0表示最干燥，99表示最湿润。\n湿度上下限默认值：湿度上限默认值为70。\n湿度下限默认值为25。\n按键消抖时间：按键消抖时间为1ms。\n显示刷新频率：数码管显示刷新频率为200ms。\n---"
  }
]